{% extends "base.html" %}

{% block title %}{{ interview_id }} - Transcript{% endblock %}

{% block extra_styles %}
.header-info {
    display: flex;
    gap: 1.5rem;
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    margin-top: 0.25rem;
}

.stats-bar {
    display: flex;
    gap: 2rem;
    margin-bottom: 1rem;
    padding: 1rem;
    background: var(--color-bg-secondary);
    border-radius: var(--radius-lg);
}

.stat-item {
    text-align: center;
}

.stat-value {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--color-text-primary);
}

.stat-label {
    font-size: 0.7rem;
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.timeline-container {
    position: sticky;
    top: 0;
    z-index: 100;
    background: var(--color-bg-primary);
    padding: 1rem 0;
    margin-bottom: 1rem;
    border-bottom: 1px solid var(--color-border);
}

.delivery-timeline {
    height: 100px;
    display: flex;
    align-items: flex-end;
    gap: 1px;
    background: var(--color-bg-secondary);
    border-radius: var(--radius-md);
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    overflow-x: auto;
}

.timeline-bar {
    min-width: 2px;
    border-radius: 2px 2px 0 0;
    cursor: pointer;
    transition: all 0.15s ease;
    position: relative;
}

.timeline-bar:hover {
    filter: brightness(1.3);
    transform: scaleY(1.05);
    transform-origin: bottom;
}

.timeline-bar.active {
    box-shadow: 0 0 0 2px var(--color-accent-primary);
}

.timeline-tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: var(--color-bg-tertiary);
    color: var(--color-text-primary);
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    font-size: 0.7rem;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.15s;
    z-index: 10;
}

.timeline-bar:hover .timeline-tooltip {
    opacity: 1;
}

.timeline-axis {
    display: flex;
    justify-content: space-between;
    padding: 0 0.5rem;
    font-size: 0.7rem;
    color: var(--color-text-muted);
    font-family: var(--font-mono);
}

.timeline-legend {
    display: flex;
    gap: 1.5rem;
    justify-content: center;
    margin-top: 0.75rem;
    font-size: 0.75rem;
    color: var(--color-text-secondary);
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.375rem;
}

.legend-color {
    width: 12px;
    height: 12px;
    border-radius: 2px;
}

.segments-container {
    margin-bottom: 4rem;
}

.segment-card {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-left: 3px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: 1rem 1.25rem;
    margin-bottom: 0.75rem;
    transition: all 0.2s ease;
}

.segment-card:hover {
    border-color: var(--color-border-light);
}

.segment-card.active {
    border-left-color: var(--color-accent-primary);
    box-shadow: 0 0 0 1px var(--color-accent-primary);
}

.segment-card.low-confidence {
    opacity: 0.7;
}

.segment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.segment-meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.segment-number {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--color-text-muted);
    font-weight: 600;
}

.segment-timecode {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--color-text-secondary);
}

.segment-confidence {
    font-size: 0.65rem;
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-sm);
    background: var(--color-warning);
    color: var(--color-text-inverse);
}

.segment-delivery {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.segment-score {
    font-family: var(--font-mono);
    font-size: 0.875rem;
    font-weight: 600;
}

.segment-score.high { color: var(--color-success); }
.segment-score.medium { color: var(--color-warning); }
.segment-score.low { color: var(--color-error); }

.segment-text {
    font-size: 0.9375rem;
    line-height: 1.7;
    color: var(--color-text-primary);
    margin-bottom: 0.75rem;
}

.segment-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.segment-themes {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
}

.theme-pill {
    font-size: 0.7rem;
    padding: 0.125rem 0.5rem;
    border-radius: var(--radius-full);
    color: white;
}

.segment-actions {
    display: flex;
    gap: 0.5rem;
}

.delivery-label {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    font-style: italic;
}

.audio-player {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--color-bg-secondary);
    border-top: 1px solid var(--color-border);
    padding: 1rem;
    display: none;
    z-index: 1000;
}

.audio-player.visible {
    display: block;
}

.audio-player-content {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.audio-player audio {
    flex: 1;
    height: 40px;
}

.audio-player-info {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    max-width: 250px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.audio-player-close {
    padding: 0.25rem 0.5rem;
    background: var(--color-bg-tertiary);
    border: none;
    border-radius: var(--radius-sm);
    color: var(--color-text-primary);
    cursor: pointer;
    font-size: 1rem;
}

.theme-legend {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    padding: 0.75rem;
    background: var(--color-bg-secondary);
    border-radius: var(--radius-md);
    margin-bottom: 1rem;
}

.theme-legend-item {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.75rem;
    color: var(--color-text-secondary);
}

.theme-legend-color {
    width: 10px;
    height: 10px;
    border-radius: 2px;
}

.no-delivery-notice {
    text-align: center;
    padding: 2rem;
    background: var(--color-bg-secondary);
    border-radius: var(--radius-lg);
    margin-bottom: 1rem;
    color: var(--color-text-secondary);
}

.no-delivery-notice code {
    background: var(--color-bg-tertiary);
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-sm);
}

@media (max-width: 640px) {
    .stats-bar {
        flex-wrap: wrap;
        gap: 1rem;
    }
    .stat-item {
        flex: 1;
        min-width: 80px;
    }
    .segment-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    .timeline-container {
        position: relative;
    }
}
{% endblock %}

{% block content %}
<div class="header">
    <div>
        <h1>Transcript</h1>
        <div class="header-meta">
            <span class="badge badge-primary">{{ interview_id }}</span>
        </div>
        <div class="header-info">
            <span>üìÅ {{ source_file }}</span>
            <span>‚è±Ô∏è {{ total_duration }}</span>
            <span>üìù {{ segment_count }} segments</span>
        </div>
    </div>
</div>

<div class="stats-bar">
    <div class="stat-item">
        <div class="stat-value">{{ total_duration }}</div>
        <div class="stat-label">Duration</div>
    </div>
    <div class="stat-item">
        <div class="stat-value">{{ segment_count }}</div>
        <div class="stat-label">Segments</div>
    </div>
    <div class="stat-item">
        <div class="stat-value {{ avg_delivery_class }}">{{ avg_score }}</div>
        <div class="stat-label">Avg Score</div>
    </div>
    {% if has_themes %}
    <div class="stat-item">
        <div class="stat-value">{{ themes|length }}</div>
        <div class="stat-label">Themes</div>
    </div>
    {% endif %}
</div>

{% if has_themes %}
<div class="theme-legend no-print">
    {% for theme in themes %}
    <div class="theme-legend-item">
        <div class="theme-legend-color" style="background: {{ theme.color }}"></div>
        <span>{{ theme.name }}</span>
    </div>
    {% endfor %}
</div>
{% endif %}

{% if has_delivery %}
<div class="timeline-container no-print">
    <div class="delivery-timeline" id="timeline"></div>
    <div class="timeline-axis" id="timelineAxis"></div>
    <div class="timeline-legend">
        <div class="legend-item">
            <div class="legend-color" style="background: rgb(74, 143, 231)"></div>
            <span>Slow pace</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: rgb(232, 93, 46)"></div>
            <span>Fast pace</span>
        </div>
        <div class="legend-item">
            <div style="display: flex; gap: 1px;">
                <div style="width: 4px; height: 12px; background: var(--color-delivery-high); border-radius: 1px;"></div>
                <div style="width: 4px; height: 8px; background: var(--color-delivery-medium); border-radius: 1px;"></div>
                <div style="width: 4px; height: 4px; background: var(--color-delivery-low); border-radius: 1px;"></div>
            </div>
            <span>Bar height = energy</span>
        </div>
    </div>
</div>
{% else %}
<div class="no-delivery-notice">
    <p>No delivery analysis available. Run <code>plotline analyze</code> to generate delivery metrics.</p>
</div>
{% endif %}

<div class="segments-container" id="segmentsContainer">
{% for segment in segments %}
<div class="segment-card {% if segment.confidence < 0.7 %}low-confidence{% endif %}"
     data-index="{{ segment.index }}"
     data-segment-id="{{ segment.id }}"
     id="segment-{{ segment.index }}">
    <div class="segment-header">
        <div class="segment-meta">
            <span class="segment-number">#{{ segment.index }}</span>
            <span class="segment-timecode">{{ segment.timecode }}</span>
            {% if segment.confidence < 0.7 %}
            <span class="segment-confidence" title="Low transcription confidence">
                {{ (segment.confidence * 100)|round }}% confident
            </span>
            {% endif %}
        </div>
        <div class="segment-delivery">
            <div class="delivery-badge">
                <div class="delivery-bar">
                    <div class="delivery-bar-segment {{ segment.delivery_class }}"></div>
                    <div class="delivery-bar-segment {{ segment.delivery_class }}"></div>
                    <div class="delivery-bar-segment {% if segment.delivery_score > 0.33 %}{{ segment.delivery_class }}{% endif %}"></div>
                </div>
            </div>
            <span class="segment-score {{ segment.delivery_class }}">{{ segment.delivery_score }}</span>
        </div>
    </div>
    <div class="segment-text">"{{ segment.text }}"</div>
    <div class="segment-footer">
        <div class="segment-themes">
            {% for theme in segment.themes %}
            <span class="theme-pill" style="background: {{ segment.theme_colors[loop.index0] }}">{{ theme }}</span>
            {% endfor %}
            {% if not segment.themes %}
            <span class="delivery-label">{{ segment.delivery_label }}</span>
            {% endif %}
        </div>
        <div class="segment-actions no-print">
            {% if segment.audio_path %}
            <button class="btn btn-secondary btn-sm" onclick="playAudio('{{ segment.audio_path }}', '{{ segment.index }}', '{{ segment.text[:50] }}...')">
                ‚ñ∂ Play
            </button>
            {% endif %}
        </div>
    </div>
</div>
{% endfor %}
</div>

<div id="audioPlayer" class="audio-player no-print">
    <div class="audio-player-content">
        <div class="audio-player-info" id="audioPlayerInfo">No audio selected</div>
        <audio id="audioElement" controls preload="auto"></audio>
        <button class="audio-player-close" onclick="closeAudio()">‚úï</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
const timelineData = {{ data_json | safe }};
const segments = timelineData.segments;
const timelineInfo = timelineData.timeline_data;
const totalDuration = timelineData.total_duration_seconds;

let activeSegmentIndex = null;

function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return mins + ':' + (secs < 10 ? '0' : '') + secs;
}

function buildTimeline() {
    const timeline = document.getElementById('timeline');
    const axis = document.getElementById('timelineAxis');
    if (!timeline || !timelineInfo || timelineInfo.length === 0) return;

    timelineInfo.forEach((seg, i) => {
        const bar = document.createElement('div');
        bar.className = 'timeline-bar';
        bar.dataset.index = seg.index;

        const height = Math.max(10, seg.energy * 85 + 5);
        bar.style.height = height + 'px';

        const rate = seg.speech_rate;
        const r = Math.round(74 + rate * 158);
        const g = Math.round(143 - rate * 50);
        const b = Math.round(231 - rate * 185);
        bar.style.background = 'rgb(' + r + ', ' + g + ', ' + b + ')';
        bar.style.opacity = 0.7 + seg.energy * 0.3;

        const widthPercent = (seg.duration / totalDuration) * 100;
        bar.style.flex = seg.duration;

        const tooltip = document.createElement('div');
        tooltip.className = 'timeline-tooltip';
        tooltip.textContent = '#' + seg.index + ' ¬∑ Score: ' + seg.delivery_score.toFixed(2);
        bar.appendChild(tooltip);

        bar.addEventListener('click', () => scrollToSegment(seg.index));
        timeline.appendChild(bar);
    });

    const marks = [0, 0.25, 0.5, 0.75, 1];
    marks.forEach(m => {
        const label = document.createElement('span');
        label.textContent = formatTime(totalDuration * m);
        axis.appendChild(label);
    });
}

function scrollToSegment(index) {
    const card = document.getElementById('segment-' + index);
    if (!card) return;

    document.querySelectorAll('.segment-card').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.timeline-bar').forEach(b => b.classList.remove('active'));

    card.classList.add('active');
    const bar = document.querySelector('.timeline-bar[data-index="' + index + '"]');
    if (bar) bar.classList.add('active');

    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
    activeSegmentIndex = index;
}

function playAudio(path, segmentIndex, textPreview) {
    const audio = document.getElementById('audioElement');
    const player = document.getElementById('audioPlayer');
    const info = document.getElementById('audioPlayerInfo');

    audio.src = path;
    audio.play().catch(() => {});
    player.classList.add('visible');
    info.textContent = '#' + segmentIndex + ': ' + textPreview;
}

function closeAudio() {
    const audio = document.getElementById('audioElement');
    const player = document.getElementById('audioPlayer');
    audio.pause();
    audio.src = '';
    player.classList.remove('visible');
}

document.addEventListener('keydown', function(e) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

    if (e.key === 'Escape') {
        closeAudio();
        return;
    }

    if (e.key === 'ArrowDown' || e.key === 'j') {
        e.preventDefault();
        if (activeSegmentIndex === null) {
            scrollToSegment(1);
        } else if (activeSegmentIndex < segments.length) {
            scrollToSegment(activeSegmentIndex + 1);
        }
    } else if (e.key === 'ArrowUp' || e.key === 'k') {
        e.preventDefault();
        if (activeSegmentIndex === null) {
            scrollToSegment(1);
        } else if (activeSegmentIndex > 1) {
            scrollToSegment(activeSegmentIndex - 1);
        }
    } else if (e.key === ' ' && activeSegmentIndex !== null) {
        e.preventDefault();
        const card = document.getElementById('segment-' + activeSegmentIndex);
        if (card) {
            const btn = card.querySelector('.btn');
            if (btn) btn.click();
        }
    }
});

document.querySelectorAll('.segment-card').forEach(card => {
    card.addEventListener('click', function(e) {
        if (e.target.tagName === 'BUTTON') return;
        const index = parseInt(this.dataset.index);
        scrollToSegment(index);
    });
});

buildTimeline();

if (segments && segments.length > 0) {
    activeSegmentIndex = 1;
}
{% endblock %}
